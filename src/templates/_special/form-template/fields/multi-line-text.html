{% set limitType = field.limitType ?? '' %}
{% set limitAmount = field.limitAmount ?? false %}
{% set limit = (field.limit ?? false) and limitAmount %}
{% set maxlength = limit and limitType == 'characters' ? limitAmount %}
{% set wordlimit = limit and limitType == 'words' ? limitAmount %}

{% set attributes = {
    id: options.id,
    class: [ 'fui-input' ],
    name: field.handle,
    placeholder: field.placeholder,
    required: field.required ? true : false,
    data: {
        'fui-message': field.settings.errorMessage,
    },
    aria: {
        required: field.required ? 'true' : 'false',
    },
} | merge(field.getInputAttributes()) %}

{% if field.useRichText %}
    {% set containerId = 'fui-rich-text-' ~ form.id ~ '-' ~ field.id ~ '-' ~ random() %}

    <div id="{{ containerId }}" class="fui-rich-text"></div>

    <div style="display: none !important;">
        <textarea {{ attr(attributes) }}>{{ value }}</textarea>
    </div>

    {% set jsFile = view.getAssetManager().getPublishedUrl('@verbb/formie/web/assets/frontend/dist/js/fields/rich-text.js', true) %}
    {% do view.registerJsFile(jsFile) %}

    {% js %}
        new FormieRichText({{ { formId: form.id, fieldId: options.id, containerId: containerId, buttons: field.richTextButtons } | json_encode | raw }});
    {% endjs %}
{% else %}
    <textarea {{ attr(attributes) }}>{{ value }}</textarea>
{% endif %}

{% if maxlength or wordlimit %}
    {% if maxlength %}
        <small class="fui-instructions fui-limit" id="{{ options.id }}-max" data-max-chars="{{ maxlength }}">
            {{ '{num} characters left' | t('formie', { num: maxlength }) | raw }}
        </small>
    {% endif %}

    {% if wordlimit %}
        <small class="fui-instructions fui-limit" id="{{ options.id }}-max" data-max-words="{{ wordlimit }}">
            {{ '{num} words left' | t('formie', { num: wordlimit }) | raw }}
        </small>
    {% endif %}

    {% set jsFile = view.getAssetManager().getPublishedUrl('@verbb/formie/web/assets/frontend/dist/js/fields/text-limit.js', true) %}
    {% do view.registerJsFile(jsFile) %}

    {% js %}
        new FormieTextLimit({{ { formId: form.id, fieldId: options.id } | json_encode | raw }});
    {% endjs %}

{% endif %}
